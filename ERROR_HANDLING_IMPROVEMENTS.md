# ุจูุจูุฏูุง Error Handling ุจุฑุง ฺุช AI

## ุชุงุฑุฎ: 2025-10-22

## ุฎูุงุตู ุชุบุฑุงุช

ฺฉ ุณุณุชู ุฌุงูุน ุจุฑุง ูุฏุฑุช ุฎุทุงูุง ู retry logic ุฏุฑ ฺุช ููุด ูุตููุน ุงุถุงูู ุดุฏ.

---

## ๐ง ุชุบุฑุงุช ุฏุฑ `ai_chat_handler.py`

### 1. ุงุถุงูู ุดุฏู Retry Settings

```python
# Retry Settings
self.max_retries = 3  # ุญุฏุงฺฉุซุฑ ุชุนุฏุงุฏ ุชูุงุด ูุฌุฏุฏ
self.retry_delay_base = 2  # ุชุฃุฎุฑ ูพุงู ุจุฑุง retry (ุซุงูู)
```

### 2. ูุชุฏ ุฌุฏุฏ: `_make_api_request()`

ฺฉ ูุชุฏ ุฎุตูุต ุจุฑุง ูุฏุฑุช ุฏุฑุฎูุงุณุชโูุง API ุจุง ูุงุจูุชโูุง ุฒุฑ:

#### โ Exponential Backoff Retry
- **ุชูุงุด ุงูู ุดฺฉุณุช ุฎูุฑุฏ**: ุตุจุฑ 2 ุซุงูู
- **ุชูุงุด ุฏูู ุดฺฉุณุช ุฎูุฑุฏ**: ุตุจุฑ 4 ุซุงูู  
- **ุชูุงุด ุณูู ุดฺฉุณุช ุฎูุฑุฏ**: ุตุจุฑ 8 ุซุงูู
- **ุจุนุฏ ุงุฒ 3 ุชูุงุด**: ุฎุทุง ุจู ฺฉุงุฑุจุฑ ููุงุด ุฏุงุฏู ูโุดูุฏ

#### ๐ ุฏุณุชูโุจูุฏ ุฎุทุงูุง

**ุฎุทุงูุง 5xx (Server Errors) - ูุงุจู retry:**
- `500` - Internal Server Error
- `503` - Service Unavailable (overload)
- `504` - Gateway Timeout

**ุฎุทุงูุง 4xx (Client Errors) - ุบุฑูุงุจู retry:**
- `400` - Bad Request
- `403` - Forbidden
- `404` - Not Found
- `429` - Too Many Requests

#### ๐ท๏ธ ุงููุงุน ุฎุทุงูุง ุจุฑฺฏุดุช

```python
error_type:
  - 'server_overload'  # ุณุฑูุฑ Google ูุดุบูู ุงุณุช (503, 500, 504)
  - 'timeout'          # ุฒูุงู ุฏุฑุฎูุงุณุช ุชูุงู ุดุฏ
  - 'network_error'    # ูุดฺฉู ุฏุฑ ุดุจฺฉู ุง ุงุฑุชุจุงุท
  - 'client_error'     # ุฎุทุง ุฏุฑุฎูุงุณุช ฺฉูุงูุช (4xx)
  - 'rate_limit'       # ูุญุฏูุฏุช ุชุนุฏุงุฏ ูพุงู
  - 'empty_message'    # ูพุงู ุฎุงู
  - 'invalid_response' # ูพุงุณุฎ ูุงูุนุชุจุฑ ุงุฒ API
  - 'unexpected_error' # ุฎุทุง ุบุฑููุชุธุฑู
```

### 3. ุจูุจูุฏ ูุงฺฏโฺฏุฐุงุฑ

```python
# ูุงฺฏ ูุจู ุงุฒ ุงุฑุณุงู ุฏุฑุฎูุงุณุช
logger.info(f"๐ ุงุฑุณุงู ุฏุฑุฎูุงุณุช ุจู Gemini (ุชุนุฏุงุฏ ูพุงูโูุง: {len(contents)})")

# ูุงฺฏ ุจุงุฑฺฏุฐุงุฑ ุชุงุฑุฎฺู
logger.info(f"๐ ุจุงุฑฺฏุฐุงุฑ {len(chat_history)} ูพุงู ุงุฒ ุชุงุฑุฎฺู ฺฉุงุฑุจุฑ {user_id}")

# ูุงฺฏ ููููุช
logger.info(f"โ ูพุงุณุฎ ูููู ุงุฒ Gemini (ุชูฺฉูโูุง: {tokens_used})")

# ูุงฺฏ ุชูุงุด ูุฌุฏุฏ
logger.info(f"โณ ุตุจุฑ {delay} ุซุงูู ูุจู ุงุฒ ุชูุงุด ูุฌุฏุฏ...")
```

---

## ๐ค ุชุบุฑุงุช ุฏุฑ `telegram_bot.py`

### Error Handling ุจูุจูุฏ ุงูุชู

ุญุงูุง ุฑุจุงุช ุจุฑุง ูุฑ ููุน ุฎุทุง ูพุงู ุงุฎุชุตุงุต ู ฺฉุงุฑุจุฑูพุณูุฏ ููุงุด ูโุฏูุฏ:

#### 1. ุฎุทุง Server Overload (503)

```
โ๏ธ ุณุฑูุฑ ููุด ูุตููุน ูุดุบูู ุงุณุช

ุณุฑูุฑ Google Gemini ุฏุฑ ุญุงู ุญุงุถุฑ ุจุงุฑ ุฒุงุฏ ุฏุงุฑุฏ.
ุงู ูุดฺฉู ูุนูููุงู ูููุช ุงุณุช.

๐ ฺู ฺฉุงุฑ ฺฉูุฏ:
โข ฺูุฏ ุฏููู ุตุจุฑ ฺฉูุฏ ู ุฏูุจุงุฑู ุงูุชุญุงู ฺฉูุฏ
โข ุง ุฏฺฉูู ๐ช ุฎุฑูุฌ ุงุฒ ฺุช ุฑุง ุจุฒูุฏ ู ุฏูุจุงุฑู ูุงุฑุฏ ุดูุฏ

_ฺฉุฏ ุฎุทุง: 503_
```

#### 2. ุฎุทุง Timeout

```
โฑ๏ธ ุฒูุงู ูพุงุณุฎโุฏู ุชูุงู ุดุฏ

ูพุงุณุฎ ููุด ูุตููุน ุจุด ุงุฒ ุญุฏ ุทููุงู ุดุฏ.
ุงู ูโุชูุงูุฏ ุจู ุฏูู ุจุงุฑ ุณูฺฏู ุณุฑูุฑ ุจุงุดุฏ.

๐ ูุทูุงู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.
```

#### 3. ุฎุทุง Network

```
๐ ุฎุทุง ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ

ูุดฺฉู ุฏุฑ ุงุฑุชุจุงุท ุจุง ุณุฑูุฑ Google Gemini ูุฌูุฏ ุฏุงุฑุฏ.

๐ ูุทูุงู ฺูุฏ ูุญุธู ุตุจุฑ ฺฉูุฏ ู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.
```

#### 4. ุฎุทุง Rate Limit

```
โฑ๏ธ ุชุนุฏุงุฏ ูพุงู ุจุด ุงุฒ ุญุฏ ูุฌุงุฒ

ูุทูุงู 45 ุซุงูู ุตุจุฑ ฺฉูุฏ ู ุฏูุจุงุฑู ุชูุงุด ฺฉูุฏ.

๐ก๏ธ ูุญุฏูุฏุช: 10 ูพุงู ุฏุฑ 60 ุซุงูู
```

---

## ๐ ูุฒุงุง ุงู ุชุบุฑุงุช

### 1. **ุชุฌุฑุจู ฺฉุงุฑุจุฑ ุจูุชุฑ**
- ูพุงูโูุง ุฎุทุง ูุงุถุญ ู ฺฉุงุฑุจุฑูพุณูุฏ
- ุฑุงูููุง ุจุฑุง ุญู ูุดฺฉู
- ููุงุด ฺฉุฏ ุฎุทุง ุจุฑุง ุฏุจุงฺฏ

### 2. **ูพุงุฏุงุฑ ุจุดุชุฑ**
- Retry ุฎูุฏฺฉุงุฑ ุจุฑุง ุฎุทุงูุง ูููุช
- ฺฉุงูุด ูุฒุงู ุดฺฉุณุช ุฏุฑ ุฏุฑุฎูุงุณุชโูุง
- ูุฏุฑุช ุจูุชุฑ ุฎุทุงูุง 503 (overload)

### 3. **ูุงฺฏโฺฏุฐุงุฑ ุจูุจูุฏ ุงูุชู**
- ุฑุฏุงุจ ุขุณุงูโุชุฑ ูุดฺฉูุงุช
- ุงุทูุงุนุงุช ุฏููโุชุฑ ุฏุฑ ูุงฺฏโูุง
- Emoji ุจุฑุง ุฎูุงูุง ุจูุชุฑ

### 4. **ูุฏุฑุช ููุงุจุน**
- ุฌููฺฏุฑ ุงุฒ ุชูุงุดโูุง ุจโูุงุฏู ุจุฑุง ุฎุทุงูุง 4xx
- Exponential backoff ุจุฑุง ฺฉุงูุด ุจุงุฑ ุณุฑูุฑ
- ุญูุธ ุชุงุฑุฎฺู ฺุช ุญุช ุฏุฑ ุตูุฑุช ุฎุทุง

---

## ๐งช ูุญูู ุชุณุช

### ุชุณุช 1: ุฎุทุง Server Overload

1. ูุงุฑุฏ ฺุช AI ุดูุฏ
2. ฺฉ ูพุงู ุงุฑุณุงู ฺฉูุฏ
3. ุงฺฏุฑ ุฎุทุง 503 ุฑุฎ ุฏูุฏุ ุจุงุฏ:
   - ุณุณุชู 3 ุจุงุฑ ุชูุงุด ฺฉูุฏ (ุจุง ููุงุตู 2ุ 4ุ 8 ุซุงูู)
   - ุฏุฑ ุตูุฑุช ุดฺฉุณุชุ ูพุงู ูุงุถุญ ุจู ฺฉุงุฑุจุฑ ููุงุด ุฏูุฏ

### ุชุณุช 2: Timeout

1. ุจุง ุงูุชุฑูุช ฺฉูุฏ ุชุณุช ฺฉูุฏ
2. ุจุงุฏ ุฎูุฏฺฉุงุฑ retry ุดูุฏ

### ุชุณุช 3: Rate Limit

1. ุจุด ุงุฒ 10 ูพุงู ุฏุฑ 60 ุซุงูู ุงุฑุณุงู ฺฉูุฏ
2. ุจุงุฏ ูพุงู ูุญุฏูุฏุช ููุงุด ุฏุงุฏู ุดูุฏ

---

## โ๏ธ ุชูุธูุงุช ูุงุจู ุชุบุฑ

```python
# ุฏุฑ ai_chat_handler.py
self.max_retries = 3           # ุชุนุฏุงุฏ ุชูุงุด ูุฌุฏุฏ
self.retry_delay_base = 2      # ุชุฃุฎุฑ ูพุงู (ุซุงูู)
self.timeout = 30              # timeout ุฏุฑุฎูุงุณุช
self.max_history_messages = 50 # ุชุนุฏุงุฏ ุชุงุฑุฎฺู
self.rate_limit_messages = 10  # ุชุนุฏุงุฏ ูพุงู ูุฌุงุฒ
self.rate_limit_seconds = 60   # ุจุงุฒู ุฒูุงู rate limit
```

---

## ๐ ูฺฉุงุช ููู

1. **ุชุนุฏุงุฏ ุชุงุฑุฎฺู ููฺูุงู 50 ุงุณุช** - ุทุจู ุฏุฑุฎูุงุณุช ฺฉุงุฑุจุฑ
2. **ููู ุฎุทุงูุง type ูุดุฎุต ุฏุงุฑูุฏ** - ุจุฑุง ุฏุจุงฺฏ ุขุณุงูโุชุฑ
3. **Retry ููุท ุจุฑุง ุฎุทุงูุง 5xx** - ุฎุทุงูุง 4xx retry ููโุดููุฏ
4. **Exponential backoff** - ุจุฑุง ฺฉุงูุด ุจุงุฑ ุณุฑูุฑ
5. **Stack trace ฺฉุงูู** - ุฏุฑ ูุงฺฏโูุง ุจุง `exc_info=True`

---

## ๐ฎ ูพุดููุงุฏุงุช ุขูุฏู

1. ุงุถุงูู ฺฉุฑุฏู Circuit Breaker ุจุฑุง ุฌููฺฏุฑ ุงุฒ ูุดุงุฑ ุจุด ุงุฒ ุญุฏ
2. ุฐุฎุฑู metrics ุฎุทุงูุง ุฏุฑ ุฏุชุงุจุณ
3. ููุชูฺฉุดู ุงุฏูู ุฏุฑ ุตูุฑุช ุฎุทุงูุง ูฺฉุฑุฑ
4. Fallback ุจู ูุฏู ุฏฺฏุฑ ุฏุฑ ุตูุฑุช overload ูุฏุงูู
