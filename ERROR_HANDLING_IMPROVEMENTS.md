# بهبودهای Error Handling برای چت AI

## تاریخ: 2025-10-22

## خلاصه تغییرات

یک سیستم جامع برای مدیریت خطاها و retry logic در چت هوش مصنوعی اضافه شد.

---

## 🔧 تغییرات در `ai_chat_handler.py`

### 1. اضافه شدن Retry Settings

```python
# Retry Settings
self.max_retries = 3  # حداکثر تعداد تلاش مجدد
self.retry_delay_base = 2  # تأخیر پایه برای retry (ثانیه)
```

### 2. متد جدید: `_make_api_request()`

یک متد خصوصی برای مدیریت درخواست‌های API با قابلیت‌های زیر:

#### ✅ Exponential Backoff Retry
- **تلاش اول شکست خورد**: صبر 2 ثانیه
- **تلاش دوم شکست خورد**: صبر 4 ثانیه  
- **تلاش سوم شکست خورد**: صبر 8 ثانیه
- **بعد از 3 تلاش**: خطا به کاربر نمایش داده می‌شود

#### 📊 دسته‌بندی خطاها

**خطاهای 5xx (Server Errors) - قابل retry:**
- `500` - Internal Server Error
- `503` - Service Unavailable (overload)
- `504` - Gateway Timeout

**خطاهای 4xx (Client Errors) - غیرقابل retry:**
- `400` - Bad Request
- `403` - Forbidden
- `404` - Not Found
- `429` - Too Many Requests

#### 🏷️ انواع خطاهای برگشتی

```python
error_type:
  - 'server_overload'  # سرور Google مشغول است (503, 500, 504)
  - 'timeout'          # زمان درخواست تمام شد
  - 'network_error'    # مشکل در شبکه یا ارتباط
  - 'client_error'     # خطای درخواست کلاینت (4xx)
  - 'rate_limit'       # محدودیت تعداد پیام
  - 'empty_message'    # پیام خالی
  - 'invalid_response' # پاسخ نامعتبر از API
  - 'unexpected_error' # خطای غیرمنتظره
```

### 3. بهبود لاگ‌گذاری

```python
# لاگ قبل از ارسال درخواست
logger.info(f"🚀 ارسال درخواست به Gemini (تعداد پیام‌ها: {len(contents)})")

# لاگ بارگذاری تاریخچه
logger.info(f"📚 بارگذاری {len(chat_history)} پیام از تاریخچه کاربر {user_id}")

# لاگ موفقیت
logger.info(f"✅ پاسخ موفق از Gemini (توکن‌ها: {tokens_used})")

# لاگ تلاش مجدد
logger.info(f"⏳ صبر {delay} ثانیه قبل از تلاش مجدد...")
```

---

## 🤖 تغییرات در `telegram_bot.py`

### Error Handling بهبود یافته

حالا ربات برای هر نوع خطا پیام اختصاصی و کاربرپسند نمایش می‌دهد:

#### 1. خطای Server Overload (503)

```
⚠️ سرور هوش مصنوعی مشغول است

سرور Google Gemini در حال حاضر بار زیادی دارد.
این مشکل معمولاً موقتی است.

🔄 چه کار کنید:
• چند دقیقه صبر کنید و دوباره امتحان کنید
• یا دکمه 🚪 خروج از چت را بزنید و دوباره وارد شوید

_کد خطا: 503_
```

#### 2. خطای Timeout

```
⏱️ زمان پاسخ‌دهی تمام شد

پاسخ هوش مصنوعی بیش از حد طولانی شد.
این می‌تواند به دلیل بار سنگین سرور باشد.

🔄 لطفاً دوباره تلاش کنید.
```

#### 3. خطای Network

```
🌐 خطای ارتباط با سرور

مشکلی در ارتباط با سرور Google Gemini وجود دارد.

🔄 لطفاً چند لحظه صبر کنید و دوباره تلاش کنید.
```

#### 4. خطای Rate Limit

```
⏱️ تعداد پیام بیش از حد مجاز

لطفاً 45 ثانیه صبر کنید و دوباره تلاش کنید.

🛡️ محدودیت: 10 پیام در 60 ثانیه
```

---

## 📈 مزایای این تغییرات

### 1. **تجربه کاربری بهتر**
- پیام‌های خطای واضح و کاربرپسند
- راهنمایی برای حل مشکل
- نمایش کد خطا برای دیباگ

### 2. **پایداری بیشتر**
- Retry خودکار برای خطاهای موقتی
- کاهش میزان شکست در درخواست‌ها
- مدیریت بهتر خطاهای 503 (overload)

### 3. **لاگ‌گذاری بهبود یافته**
- ردیابی آسان‌تر مشکلات
- اطلاعات دقیق‌تر در لاگ‌ها
- Emoji برای خوانایی بهتر

### 4. **مدیریت منابع**
- جلوگیری از تلاش‌های بی‌فایده برای خطاهای 4xx
- Exponential backoff برای کاهش بار سرور
- حفظ تاریخچه چت حتی در صورت خطا

---

## 🧪 نحوه تست

### تست 1: خطای Server Overload

1. وارد چت AI شوید
2. یک پیام ارسال کنید
3. اگر خطای 503 رخ دهد، باید:
   - سیستم 3 بار تلاش کند (با فواصل 2، 4، 8 ثانیه)
   - در صورت شکست، پیام واضح به کاربر نمایش دهد

### تست 2: Timeout

1. با اینترنت کند تست کنید
2. باید خودکار retry شود

### تست 3: Rate Limit

1. بیش از 10 پیام در 60 ثانیه ارسال کنید
2. باید پیام محدودیت نمایش داده شود

---

## ⚙️ تنظیمات قابل تغییر

```python
# در ai_chat_handler.py
self.max_retries = 3           # تعداد تلاش مجدد
self.retry_delay_base = 2      # تأخیر پایه (ثانیه)
self.timeout = 30              # timeout درخواست
self.max_history_messages = 50 # تعداد تاریخچه
self.rate_limit_messages = 10  # تعداد پیام مجاز
self.rate_limit_seconds = 60   # بازه زمانی rate limit
```

---

## 📝 نکات مهم

1. **تعداد تاریخچه همچنان 50 است** - طبق درخواست کاربر
2. **همه خطاها type مشخص دارند** - برای دیباگ آسان‌تر
3. **Retry فقط برای خطاهای 5xx** - خطاهای 4xx retry نمی‌شوند
4. **Exponential backoff** - برای کاهش بار سرور
5. **Stack trace کامل** - در لاگ‌ها با `exc_info=True`

---

## 🔮 پیشنهادات آینده

1. اضافه کردن Circuit Breaker برای جلوگیری از فشار بیش از حد
2. ذخیره metrics خطاها در دیتابیس
3. نوتیفیکیشن ادمین در صورت خطاهای مکرر
4. Fallback به مدل دیگر در صورت overload مداوم
