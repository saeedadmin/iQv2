# 🤖 قابلیت‌وای جدید چت با هوش مصنوعی

## خلاصه تغییرات

سیستم چت با هوش مصنوعی به‌روزرسانی شد و قابلیت‌های زیر اضافه گردید:

### 1. 🗄️ حافظه مکالمه (Chat History)

- ✅ **ذخیره تاریخچه**: تمام پیام‌های کاربر و پاسخ‌های AI در دیتابیس ذخیره می‌شوند
- ✅ **استفاده از تاریخچه**: با هر پیام جدید، تمام تاریخچه چت به Gemini API ارسال می‌شه
- ✅ **محدودیت تاریخچه**: حداکثر 50 پیام آخر برای جلوگیری از overload
- ✅ **پاکسازی خودکار**: وقتی کاربر از چت خارج می‌شه، تاریخچه پاک می‌گردد

#### مثال کاربردی:
```
کاربر: اسمم علی هست
AI: سلام علی! خوشحالم که باهات آشنا شدم.

کاربر: اسمم رو یادته؟
AI: بله، اسمت علی هست! 😊

کاربر: درباره پایتون بهم بگو
AI: حتماً علی! پایتون یک زبان برنامه‌نویسی...
```

### 2. 🛡️ Rate Limiting (محدودیت تعداد پیام)

- ✅ **محدودیت**: 10 پیام در 60 ثانیه (قابل تنظیم)
- ✅ **هشدار به کاربر**: بعد از رسیدن به محدودیت، پیام مناسب با زمان انتظار نمایش داده می‌شه
- ✅ **جلوگیری از سوءاستفاده**: محافظت از API در برابر درخواست‌های متعدد

#### پیام محدودیت:
```
⏱️ تعداد پیام بیش از حد مجاز

لطفاً 45 ثانیه صبر کنید و دوباره تلاش کنید.

🛡️ محدودیت: 10 پیام در 60 ثانیه
```

### 3. 💻 فرمت کد با Syntax Highlighting

- ✅ **تشخیص Code Blocks**: به صورت خودکار کدها را تشخیص می‌دهد
- ✅ **فرمت HTML**: از تگ‌های `<pre>` و `<code>` برای فرمت مناسب استفاده می‌کند
- ✅ **دکمه کپی**: تلگرام به صورت خودکار دکمه کپی اضافه می‌کند
- ✅ **پشتیبانی از Inline Code**: کدهای درون متن با `code` فرمت می‌شوند

#### مثال کد:
وقتی AI کد بنویسد، اینطور نمایش داده می‌شه:

```python
def hello():
    print("Hello World")
```

با قابلیت کپی یک کلیکی! ⚙️

### 4. 🛡️ امنیت و Sanitization

- ✅ **حذف کاراکترهای خطرناک**: کاراکترهای کنترلی مخرب حذف می‌شوند
- ✅ **محدودیت طول پیام**: حداکثر 4000 کاراکتر برای هر پیام
- ✅ **HTML Escape**: برای جلوگیری از خطاهای فرمت
- ✅ **تقسیم پیام‌های بلند**: پیام‌های بلندتر از 4096 کاراکتر خودکار تقسیم می‌شوند

---

## فایل‌های تغییر یافته

### 1. `database_postgres.py`

**تغییرات:**
- ✅ اضافه جدول `ai_chat_history` برای ذخیره تاریخچه چت
- ✅ متدهای جدید:
  - `add_chat_message(user_id, role, message_text)` - اضافه پیام به تاریخچه
  - `get_chat_history(user_id, limit)` - دریافت تاریخچه چت
  - `clear_chat_history(user_id)` - پاک کردن تاریخچه
  - `get_chat_history_count(user_id)` - تعداد پیام‌ها

### 2. `ai_chat_handler.py`

**بازنویسی کامل** با قابلیت‌های جدید:

#### `GeminiChatHandler`:
- ✅ `send_message_with_history(user_id, message)` - ارسال پیام با تاریخچه
- ✅ `check_rate_limit(user_id)` - بررسی rate limiting
- ✅ `sanitize_input(text)` - پاکسازی ورودی
- ✅ `format_code_blocks(text)` - فرمت کردن کد
- ✅ `format_response_for_telegram(text)` - فرمت خروجی برای تلگرام

#### `AIChatStateManager`:
- ✅ `end_chat(user_id)` - حالا تاریخچه را هم پاک می‌کند

### 3. `telegram_bot.py`

**تغییرات:**
- ✅ استفاده از `send_message_with_history()` به جای `send_message()`
- ✅ اضافه پشتیبانی از rate limit errors
- ✅ فرمت مناسب پیام‌های rate limit

---

## نحوه تست

برای تست قابلیت‌های جدید:

```bash
python test_ai_chat.py
```

این فایل تست بررسی می‌کند:
1. حافظه مکالمه (AI اسم شما را یاد می‌گیرد)
2. Rate Limiting (12 پیام سریع برای تست)
3. فرمت کد (code blocks و inline code)
4. Sanitization (حذف کاراکترهای خطرناک)
5. تاریخچه دیتابیس (ذخیره و پاکسازی)

---

## تنظیمات

می‌توانید تنظیمات را در `ai_chat_handler.py` تغییر دهید:

```python
self.max_message_length = 4000  # حداکثر طول پیام کاربر
self.timeout = 30  # تایم‌اوت درخواست
self.max_history_messages = 50  # حداکثر تعداد پیام‌های تاریخچه

# Rate Limiting
self.rate_limit_messages = 10  # تعداد پیام مجاز
self.rate_limit_seconds = 60  # در چند ثانیه
```

---

## مثال استفاده

### 1. چت عادی با حافظه:

```
کاربر: اسمم علی هست
AI: سلام علی! خوشحالم که باهات آشنا شدم.

کاربر: اسمم رو یادته؟
AI: بله، اسمت علی هست! 😊
```

### 2. درخواست کد:

```
کاربر: یه کد پایتون برای سلام دنیا بنویس
AI: حتماً! اینجا یک مثال ساده:

```python
def hello_world():
    print("Hello, World!")

hello_world()
```

برای اجرا فقط فایل رو ذخیره کن و با `python hello.py` اجرا کن!
```

### 3. Rate Limit:

```
کاربر: (پیام 11م در کمتر از 60 ثانیه)

AI: 
⏱️ تعداد پیام بیش از حد مجاز

لطفاً 45 ثانیه صبر کنید و دوباره تلاش کنید.

🛡️ محدودیت: 10 پیام در 60 ثانیه
```

---

## مزایا

✅ **تجربه کاربری بهتر**: چت‌های طبیعی‌تر با حافظه مکالمه  
✅ **مصرف بهینه**: Rate limiting برای مدیریت API quota  
✅ **نمایش حرفه‌ای**: فرمت زیبای کد با دکمه کپی  
✅ **امنیت بیشتر**: Sanitization ورودی و فیلترینگ  
✅ **مقیاس‌پذیری**: مدیریت تعداد زیاد کاربران  

---

## Commit Message

```
feat: اضافه حافظه مکالمه، rate limiting و فرمت کد به چت AI

- ✅ حافظه مکالمه: تاریخچه چت در دیتابیس ذخیره و به API ارسال می‌شود
- ✅ Rate limiting: 10 پیام در 60 ثانیه با پیام مناسب
- ✅ فرمت کد: تشخیص خودکار و فرمت HTML برای code blocks
- ✅ امنیت: Sanitization ورودی، محدودیت طول، HTML escape
- ✅ پاکسازی خودکار تاریخچه هنگام خروج از چت

Breaking Changes: خیر

Files Modified:
- database_postgres.py (جدول ai_chat_history + 4 متد جدید)
- ai_chat_handler.py (بازنویسی کامل)
- telegram_bot.py (استفاده از متد جدید)

Files Added:
- test_ai_chat.py (تست قابلیت‌های جدید)
- AI_CHAT_FEATURES.md (مستندات)
```

---

نویسنده: **MiniMax Agent**  
تاریخ: 2025-10-22
