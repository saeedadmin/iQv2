# 📰 قابلیت دنبال کردن اخبار خودکار

## 📋 خلاصه
این قابلیت به کاربران اجازه می‌دهد تا به صورت خودکار سرتیتر آخرین اخبار روز را در 3 زمان مشخص دریافت کنند.

## ✨ ویژگی‌ها

### ⏰ زمان‌بندی ارسال
اخبار به صورت خودکار در 3 زمان به وقت ایران (Asia/Tehran) ارسال می‌شود:
- 🌅 **صبج**: 8:00
- 🌇 **ظهر**: 14:00 
- 🌃 **شب**: 20:00

### 📰 محتوا
سرتیتر آخرین اخبار روز از منبع معتبر فارسی (تسنیم)

### ✅ مزایا
- **رایگان** و **بدون محدودیت**
- امکان فعال/غیرفعال‌سازی آسان
- بلاک خودکار کاربرانی که ربات را بلاک کرده‌اند
- گزارش کامل به ادمین پس از هر ارسال

## 🛠️ جزئیات فنی

### تغییرات دیتابیس
فیلد جدید به جدول `users` اضافه شد:
```sql
news_subscription_enabled INTEGER DEFAULT 0
```

### توابع جدید در `database.py`
- `enable_news_subscription(user_id)`: فعال‌سازی اشتراک
- `disable_news_subscription(user_id)`: غیرفعال‌سازی اشتراک
- `is_news_subscribed(user_id)`: بررسی وضعیت اشتراک
- `get_news_subscribers()`: دریافت لیست مشترکان فعال

### کیبورد‌ها در `keyboards.py`
کیبورد بخش عمومی حالا **داینامیک** است:
- اگر کاربر مشترک نباشد: دکمه "📰 دنبال کردن اخبار"
- اگر کاربر مشترک باشد: دکمه "🔕 لغو اشتراک اخبار"

### Scheduler در `telegram_bot.py`
از `APScheduler` با `AsyncIOScheduler` استفاده شده:
```python
scheduler = AsyncIOScheduler(timezone=pytz.timezone('Asia/Tehran'))

scheduler.add_job(
    send_scheduled_news,
    trigger=CronTrigger(hour=8, minute=0, timezone='Asia/Tehran'),
    args=[application],
    id='morning_news'
)
# ... (مشابه برای 14:00 و 20:00)
```

### تابع ارسال خودکار
`send_scheduled_news(context)` در `telegram_bot.py`:
1. دریافت لیست مشترکان فعال
2. دریافت آخرین اخبار از API
3. ارسال برای هر مشترک (با تاخیر 50ms برای جلوگیری از flood)
4. غیرفعال‌سازی خودکار اشتراک کاربرانی که ربات را بلاک کرده‌اند (Forbidden error)
5. ارسال گزارش کامل به ادمین

### Handler ها
در `telegram_bot.py`:
- `news_subscription_callback()`: مدیریت callback query برای دکمه‌های تایید/انصراف
- Handler برای دکمه "📰 دنبال کردن اخبار" در `fallback_handler`
- Handler برای دکمه "🔕 لغو اشتراک اخبار" در `fallback_handler`

## 📋 Migration
برای اضافه کردن فیلد جدید به دیتابیس موجود:
```bash
python migrate_news_subscription.py
```

## 👤 تجربه کاربر

### فعال‌سازی اشتراک
1. کاربر به بخش عمومی می‌رود
2. روی "📰 دنبال کردن اخبار" کلیک می‌کند
3. پیام توضیحی با دکمه‌های تایید/انصراف نمایش داده می‌شود
4. پس از تایید، اشتراک فعال و دکمه به "🔕 لغو اشتراک" تغییر می‌کند

### غیرفعال‌سازی اشتراک
1. کاربر روی "🔕 لغو اشتراک اخبار" کلیک می‌کند
2. اشتراک غیرفعال و دکمه به "📰 دنبال کردن اخبار" تغییر می‌کند

## 📊 گزارش به ادمین
پس از هر بار ارسال خودکار، گزارش کاملی برای ادمین ارسال می‌شود شامل:
- ⏰ زمان ارسال
- ✅ تعداد موفق
- ❌ تعداد ناموفق
- 👥 جمع مشترکان فعال

## 🔍 لاگ‌گیری
تمام عملیات مربوط به اشتراک اخبار لاگ می‌شوند:
- فعال‌سازی اشتراک
- غیرفعال‌سازی اشتراک
- ارسال خودکار اخبار
- خطاها و مشکلات

## 🔒 امنیت
- فقط کاربران غیربلاک شده اخبار دریافت می‌کنند
- کاربرانی که ربات را بلاک کنند، به صورت خودکار از لیست مشترکان حذف می‌شوند
- تاخیر 50ms بین ارسال برای جلوگیری از Telegram Flood Limit

## 📝 فایل‌های تغییر یافته
1. `database.py` - توابع مدیریت اشتراک
2. `keyboards.py` - کیبورد داینامیک بخش عمومی
3. `telegram_bot.py` - تابع ارسال خودکار، handler ها، و scheduler
4. `migrate_news_subscription.py` - اسکریپت migration

---

نویسنده: MiniMax Agent  
تاریخ: 2025-10-22
